# 多源辅助数据驱动的叶绿素（Chl-a）日尺度缺失填充：多源预处理数据输入 → FNO+CBAM（整图训练：目标区域直接训练 + 推理）

本项目以**目标区域已完成数据预处理后的叶绿素产品**（云遮挡/缺测为 NaN）为目标变量，用 **FNO + CBAM** 的时序模型在 daily 序列上填补缺失像元。

为增强对季节性与海洋动力过程的表征，训练时引入多源辅助特征：**JAXA SST、经纬度（归一化坐标）、时间编码（day-of-year sin/cos）**，并在模型内部基于 SST 计算 **距平/梯度/拉普拉斯** 等特征工程。

最终目标是把**目标区域（15–24N, 111–118E）全时段（~10年）的 daily Chl-a 产品全部补齐**。

> 重要约束  
> - 训练不依赖“无云真值数据集”：统一采用**自监督挖空重建**（只在真实观测像元里人工挖空，loss 只在挖空处计算）。  
> - 训练方式采用**整图训练**（不是 patch）。

---

## 目录
1. 任务与数据范围  
2. 数据格式与掩码约定  
3. 叶绿素和SST等数据已经提前预处理好，训练实验过程无需再数据预处理
5. Baseline 填充（仅用于喂模型）  
6. 模型输入输出（整图训练）  
7. 掩码策略（真实缺失 + 人工挖空）  
8. Loss 设计（最简单的MAE）  
9. 训练流程：目标区直接训练（可断点续训）  
10. 推理流程（全时段 daily 产物）  
11. 评价方式（无真值场景）  
12. 默认超参（可直接跑）  
13. 实现清单（建议脚本/模块）

---

## 1) 任务与数据范围

### 1.1 目标区域（最终要填好的区域）
- 纬度范围：**15.0°N ~ 24.0°N**  
- 经度范围：**111.0°E ~ 118.0°E**  
- 时间跨度：约 **10 年**  
- 目标：把该区域所有 daily 都填好（每天一张）
- 本项目训练数据（已 KNN 预处理）：`/data_new/chla_data_imputation_data_260125/chla_data_pretraining/filled_target_modified/`

---

## 2) 数据格式与掩码约定

### 2.1 原始小时叶绿素
- 小时叶绿素：`C(t, x, y)`，单位 mg/m³  
- 云/缺测/无效像元：`NaN`  
- 陆地区域：`land_mask(x,y)` 指定（陆地=1，海洋=0），陆地永远视作缺失（不填）

### 2.2 掩码语义统一
全项目统一 mask 语义：
- `mask = 1` ：缺失/需要填补
- `mask = 0` ：有观测/可作为监督真值

---

## 3) 叶绿素预处理（你给的公式）

我们在**归一化空间**训练模型，稳定且跨海域更鲁棒。

### 3.1 数值截断（mg/m³）
- 下限截断：`C = max(C, 0.01)`  
- （推荐）上限截断：`C = min(C, 100.0)`（稳定训练，抑制离群）

### 3.2 对数归一化（公式）
$$
C_N = \frac{\ln(C) + 4.61}{4.61 \times 2} = \frac{\ln(C) + 4.61}{9.22}
$$
实现建议再裁剪：
- `C_N = clip(C_N, 0, 1)`

### 3.3 反归一化（输出 mg/m³）
$
\ln(C)=9.22\cdot C_N-4.61,\quad C=\exp(\ln(C))
$
输出可再 `clip(C, 0.01, 100)`（可选）。

---


## 4) Baseline 填充（仅用于喂模型）

FNO+CBAM 需要 dense 数值输入，因此对 daily 做一次输入填充，得到 `D_d_filled`：
- 输入：`D_d`（可能含 NaN）、`missing_mask_d`
- 方法：KNN 
- 输出：`D_d_filled`（海洋全域有数值）

注意：
- baseline 不是最终结果，不当真值
- 最终输出仍采用 output composition：观测处不改，缺失处替换为模型输出

---

## 5) 模型输入输出（整图训练）

对目标日 d，构造 30 天窗口 `d-29 ... d`：

### 5.1 输入 (152 通道)
模型输入维度为 `[B, 152, H, W]`，包含以下特征拼接（按顺序）：
1. **JAXA SST** (30通道): 与 Chl-a 同期的 SST 数据 `[d-29 ... d]`。
2. **Chl-a** (30通道): 掩码后的叶绿素数据 `[d-29 ... d]`。
3. **Mask** (30通道): 叶绿素缺失掩码 `[d-29 ... d]`。
4. **Lat** (1通道): 归一化纬度网格。
5. **Lon** (1通道): 归一化经度网格。
6. **Day Sin** (30通道): 时间编码 sin(day_of_year)。
7. **Day Cos** (30通道): 时间编码 cos(day_of_year)。

### 5.2 特征工程模块 (内置)
模型会在内部基于 SST 计算以下辅助特征（90通道），并拼接到输入中：
- **sst_anom** (30通道): SST 距平（减去当前窗口的时间均值）。
- **|∇sst|** (30通道): SST 梯度模长（Sobel算子）。
- **Δsst** (30通道): SST 拉普拉斯（二阶导数）。

最终进入 FNO 主干的特征数为 152 + 90 = 242 通道。

### 5.3 输出
- $ pred_d = \hat{D}_d$ $ → $ $ shape [B, 1, H, W]（或 [B, H, W]）$
- 输出为目标日（窗口最后一天）的 Chl-a 重建结果，仍在归一化空间$ （0~1） $

### 5.4 输出合成（保证观测不被改）
- `D_out = D_d` where `missing_mask_d == 0`
- `D_out = pred_d` where `missing_mask_d == 1`

然后反归一化回 mg/m³。

---

## 6) 掩码策略（真实缺失 + 人工挖空）

没有无云真值时，监督信号来自“真实观测像元的人工挖空”。

### 6.1 真实缺失（需要补但无真值）
- `missing_mask_d == 1`：云遮挡/缺测（daily 后仍缺失）
- 对这部分不能做强监督

### 6.2 人工挖空（产生监督真值）
对目标日 d：
1) 候选区域：海洋且真实观测 `missing_mask_d==0`
2) 随机采样得到 `artificial_mask_d`（1=人为挖空）


用于计算重建 loss 的监督区域：
- `loss_mask = artificial_mask_d`（这里有真值 `D_d`）

---

## 7) Loss 设计（简化：Masked MAE）

训练时只保留最原始的重建损失：**Masked MAE**。

### 7.1 强监督：只在人工挖空处算（有真值）
- `loss_mask = artificial_mask_d`
- `L = MAE(pred_d, D_d)` on `loss_mask`

归一化写法：
- $$
   L = sum(|pred_d - D_d| * loss_mask) / (loss_mask.sum() + eps)
  $$

---

## 8) 训练流程：目标区直接训练（可断点续训）

训练阶段使用目标区全时段数据，采用自监督挖空重建：
- 输入：多源特征拼接后的 `[B, 152, H, W]`，模型内部再拼接 SST 特征工程
- 监督：仅在真实观测像元内人工挖空，loss 只在挖空处计算
- 损失：Masked MAE（不再使用 baseline 贴合项）


**断点续训（继续训练）**
- 训练脚本支持从 checkpoint 继续：加载 `model/optimizer/scheduler` 并从 `epoch+1` 接着跑。

---

## 9) 推理（Inference，生成目标区全时段 daily）

对目标区每一天 d：
1) baseline 填充得到 `D_d_filled`
2) 取窗口 `d-29 ... d`，构建 `input=[X,M]`
3) 模型输出 `pred_d`
4) 合成 `D_out`（观测不变、缺失替换）
5) 反归一化回 mg/m³，输出 daily 产品

---

## 10) 评价方式（缺失区无真值）

由于真实缺失区没有真值，评估采用“自监督挖空验证”：
- 在 `missing_mask_d==0` 的真实观测像元里随机挖空一部分作为验证集
- 仅在被挖空区域计算 RMSE/MAE（按月/按季节分统计）
- 专门统计高缺失天的表现（missing_ratio 高 / support 低）

---

---

## 11) 实现清单（当前仓库）

1) 训练
   - `training/train_chla_finetune.py`：目标区全时段直接训练（支持断点续训）
   - `models/fno_cbam_chla.py`：FNO+CBAM 主干 + SST 特征工程（距平/梯度/拉普拉斯）
   - `datasets/chla_dataset_finetune.py`：目标区数据集（30 天游标窗口 + 人工挖空；需输出多源特征输入）
   - `losses/chla_loss.py`：Masked MAE（只在人工挖空区域算）
   - `scripts/run_chla_finetune.sh`：DDP 启动脚本（默认 8 卡）

2) 推理
   - `inference/infer_chla.py`：全时段推理并输出 NetCDF
   - `scripts/inference_chla.sh`：推理启动脚本

3) 可视化
   - `visualization/plot_chla_4panel.py`：4 连图可视化
   - `scripts/plot.sh`：绘图脚本示例

---

### 工程注意事项（强提醒）
- 训练与推理必须使用同一套归一化与 mask 语义，否则会造成分布不一致导致效果下降。
